[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Salary Structure Assignment",
  "enabled": 1,
  "modified": "2026-01-07 16:37:04.503609",
  "module": "NASECO ERP",
  "name": "Negotiated Net Preview",
  "script": "frappe.ui.form.on(\"Salary Structure Assignment\", {\n    negotiated_net: function(frm) {\n        if (!frm.doc.negotiated_net) return;\n\n        // Simplified URA PAYE: all employees fall between 410,001 and 10,000,000\n        function compute_paye(basic) {\n            return 25000 + 0.30 * (gross - 410000);\n        }\n\n        let net_target = frm.doc.negotiated_net;\n        let gross = net_target / 0.75;   // initial guess\n\n        // Iterate until Net â‰ˆ Negotiated Net\n        for (let i = 0; i < 50; i++) {\n            let transport = 0.15 * gross;\n            let accommodation = 0.15 * gross;\n            let lunch = 0.10 * gross;\n            let basic = gross - (transport + accommodation + lunch);\n\n            let nssf_employee = 0.05 * gross;\n            let paye = compute_paye(gross);\n\n            let net = gross - nssf_employee - paye;\n\n            if (Math.abs(net - net_target) < 0.1) {\n                break;\n            }\n            gross = gross + (net_target - net); // refine gross iteratively\n        }\n\n        // Final values\n        let transport = 0.15 * gross;\n        let accommodation = 0.15 * gross;\n        let lunch = 0.10 * gross;\n        let basic = gross - (transport + accommodation + lunch);\n        let nssf_employee = 0.05 * gross;\n        let paye = compute_paye(gross);\n        let nssf_employer = 0.10 * gross;\n        let net = gross - nssf_employee - paye;\n        let ctc = gross + nssf_employer;\n\n        // Set Base field (Gross Pay)\n        frm.set_value(\"base\", Math.round(gross));\n\n        // ðŸ”¹ Update or insert PAYE (From Taxable)\n        let paye_row = (frm.doc.deductions || []).find(d => d.salary_component === \"PAYE (From Taxable)\");\n        if (paye_row) {\n            paye_row.amount = Math.round(paye);\n        } else {\n            frm.add_child(\"deductions\", {\n                salary_component: \"PAYE (From Taxable)\",\n                amount: Math.round(paye)\n            });\n        }\n        frm.refresh_field(\"deductions\");\n\n        // ðŸ”¹ Always show popup breakdown\n        frappe.msgprint({\n            title: __(\"Salary Breakdown\"),\n            indicator: \"blue\",\n            message: `\n                <b>Negotiated Net:</b> ${net_target.toLocaleString()} UGX<br><br>\n                <b>Gross Pay (Base):</b> ${gross.toFixed(0)} UGX<br>\n                â”œâ”€â”€ Basic Salary (Taxable): ${basic.toFixed(0)} UGX<br>\n                â”œâ”€â”€ Transport Allowance: ${transport.toFixed(0)} UGX<br>\n                â”œâ”€â”€ Accommodation Allowance: ${accommodation.toFixed(0)} UGX<br>\n                â”œâ”€â”€ Lunch Allowance: ${lunch.toFixed(0)} UGX<br><br>\n                <b>Deductions:</b><br>\n                â”œâ”€â”€ NSSF Employee (5%): ${nssf_employee.toFixed(0)} UGX<br>\n                â”œâ”€â”€ PAYE (From Taxable): ${paye.toFixed(0)} UGX<br><br>\n                <b>Net Pay:</b> ${net.toFixed(0)} UGX<br>\n                <b>Employer NSSF (10%):</b> ${nssf_employer.toFixed(0)} UGX<br>\n                <b>Cost to Company (CTC):</b> ${ctc.toFixed(0)} UGX\n            `\n        });\n    }\n});\n\n\n\n",
  "view": "Form"
 }
]